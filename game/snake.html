<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Snake - ArcadeHub</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        main { 
            padding-bottom: 60px; 
        }
        .game-container { 
            position: relative; 
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        canvas {
            background: #111;
        }
        #start-screen { 
            position: absolute; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.7); 
            color: white; 
            font-family: 'Press Start 2P', cursive; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            text-align: center; 
            z-index: 200; 
            flex-direction: column;
        }
        #start-screen button {
            background-color: var(--color-tertiary-glow); 
            color: black; 
            border: none; 
            padding: 15px 30px; 
            font-family: 'Press Start 2P', cursive; 
            font-size: 1.2rem; 
            cursor: pointer; 
            border-radius: 5px; 
            transition: transform 0.3s; 
            margin-top: 20px;
        }
        #start-screen button:hover {
            transform: scale(1.1);
        }

        #game-over-screen { 
            position: absolute; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.85); 
            color: white; 
            font-family: 'Press Start 2P', cursive; 
            display: none; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            text-align: center; 
            z-index: 100; 
        }
        #game-over-screen h2 { 
            font-size: 2.5rem; 
            margin-bottom: 20px;
            animation: glitch-effect 1.5s infinite;
            color: var(--color-primary-glow); 
            text-shadow: 0 0 10px var(--color-primary-glow); 
        }
        #game-over-screen p { 
            margin: 10px 0; 
            font-size: 1.1rem; 
        }
        #game-over-screen button { 
            margin-top: 20px; 
            background-color: var(--color-tertiary-glow); 
            color: black; 
            border: none; 
            padding: 15px 30px; 
            font-family: 'Press Start 2P', cursive; 
            font-size: 1rem; 
            cursor: pointer; 
            border-radius: 5px; 
            transition: transform 0.3s; 
        }

        /* NOUVEAUX STYLES POUR LES CONFETTIS */
        #confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Pour pouvoir cliquer à travers */
            z-index: 999;
            overflow: hidden;
        }

        .confetti-particle {
            position: absolute;
            width: 8px;
            height: 12px;
            border-radius: 2px;
            will-change: transform;
        }

    </style>
</head>
<body>
    <div id="confetti-container"></div>
    <button id="music-toggle-btn" title="Activer/Désactiver la musique"></button>
    <div class="background-grid"></div>
    <header>
        <h1 class="glitch" data-text="SNAKE">SNAKE</h1>
    </header>
    <main>
        <div class="game-container">
            <div id="start-screen">
                <p>BIENVENUE SUR SNAKE !</p>
                <button id="startButton">JOUER</button>
            </div>
            <canvas id="gameCanvas" width="400" height="400"></canvas>
            
            <div id="game-over-screen">
                <h2 class="glitch" data-text="GAME OVER">GAME OVER</h2>
                <p>Score final: <span id="final-score-over">0</span></p>
                <p>Meilleur Score: <span id="highscore-over">0</span></p>
                <button onclick="restartGame()">REJOUER</button>
            </div>

        </div>
        <a href="index.html" class="back-button">&lt; RETOUR</a>
    </main>

    <script>
        // ... BLOC AUDIO GLOBAL (inchangé) ...
        const musicPlayer = new Audio('sounds/ambiance.mp3');
        musicPlayer.loop = true; musicPlayer.volume = 0.3;
        window.addEventListener('beforeunload', () => { if (!musicPlayer.paused) localStorage.setItem('musicCurrentTime', musicPlayer.currentTime); });
        function playSound(src, volume = 1.0) { const audio = new Audio(src); audio.volume = volume; audio.play(); }
        document.addEventListener('DOMContentLoaded', () => {
            const clickableElements = document.querySelectorAll('button, a.back-button');
            clickableElements.forEach(elem => { if (elem.id !== 'music-toggle-btn') elem.addEventListener('click', () => playSound('sounds/click.mp3')); });
            const musicBtn = document.getElementById('music-toggle-btn');
            const syncMusicState = () => {
                if (localStorage.getItem('musicState') === 'playing') {
                    const savedTime = parseFloat(localStorage.getItem('musicCurrentTime') || '0');
                    musicPlayer.currentTime = savedTime; musicPlayer.play().catch(e => {}); musicBtn.classList.add('playing');
                } else { musicPlayer.pause(); musicBtn.classList.remove('playing'); }
            };
            musicBtn.addEventListener('click', () => {
                if (musicPlayer.paused) localStorage.setItem('musicState', 'playing'); else { localStorage.setItem('musicState', 'paused'); localStorage.removeItem('musicCurrentTime'); }
                syncMusicState();
            });
            syncMusicState();
        });

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameOverScreen = document.getElementById('game-over-screen');
        const finalScoreOver = document.getElementById('final-score-over');
        const highscoreOver = document.getElementById('highscore-over');
        
        const startScreen = document.getElementById('start-screen');
        const startButton = document.getElementById('startButton');

        const confettiContainer = document.getElementById('confetti-container');
        const confettiColors = ['#ff00c1', '#00f2ff', '#fffb00'];

        const box = 20;
        let snake, food, score, highscore, d, game;
        let speed = 120;
        let gameStarted = false;
        let touchStartX = 0, touchStartY = 0;
        
        let highScoreBeatenThisGame;

        function init() {
            snake = [{ x: 9 * box, y: 10 * box }];
            d = null;
            score = 0;
            highscore = parseInt(localStorage.getItem('snakeHighscore') || '0'); 
            speed = 120;
            highScoreBeatenThisGame = false;
            confettiContainer.innerHTML = ''; // Nettoie les anciens confettis
            spawnFood();
            
            gameOverScreen.style.display = 'none';
            startScreen.style.display = 'flex';
            
            if (game) clearInterval(game);
            
            drawInitialState();
        }

        function startGameLogic() {
            if (gameStarted) return;
            gameStarted = true;
            startScreen.style.display = 'none';
            game = setInterval(gameLoop, speed);
        }

        startButton.addEventListener('click', startGameLogic);
        
        document.addEventListener("keydown", (event) => {
            startGameLogic();
            let key = event.keyCode;
            if (key == 37 && d != "RIGHT") d = "LEFT";
            else if (key == 38 && d != "DOWN") d = "UP";
            else if (key == 39 && d != "LEFT") d = "RIGHT";
            else if (key == 40 && d != "UP") d = "DOWN";
        });
        
        canvas.addEventListener('touchstart', e => { e.preventDefault(); startGameLogic(); touchStartX = e.changedTouches[0].clientX; touchStartY = e.changedTouches[0].clientY; }, { passive: false });
        canvas.addEventListener('touchmove', e => { e.preventDefault(); }, { passive: false });
        canvas.addEventListener('touchend', e => {
            e.preventDefault();
            const touchEndX = e.changedTouches[0].clientX; const touchEndY = e.changedTouches[0].clientY;
            const dx = touchEndX - touchStartX; const dy = touchEndY - touchStartY;
            const minSwipeDist = 20;
            if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > minSwipeDist) { if (dx > 0 && d !== "LEFT") d = "RIGHT"; else if (dx < 0 && d !== "RIGHT") d = "LEFT"; } 
            else if (Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > minSwipeDist) { if (dy > 0 && d !== "UP") d = "DOWN"; else if (dy < 0 && d !== "DOWN") d = "UP"; }
        }, { passive: false });

        function collision(head, array) {
            for (let i = 0; i < array.length; i++) { if (head.x == array[i].x && head.y == array[i].y) return true; }
            return false;
        }

        function spawnFood() {
            food = { x: Math.floor(Math.random() * 19 + 1) * box, y: Math.floor(Math.random() * 19 + 1) * box };
            if(collision(food, snake)) spawnFood();
        }

        function restartGame() {
            gameStarted = false;
            init();
        }
        
        // ## NOUVELLE LOGIQUE POUR LES CONFETTIS SUR LA PAGE ##
        function createConfettiBurst() {
            for (let i = 0; i < 80; i++) { // Augmenté pour couvrir les deux côtés
                const confetti = document.createElement('div');
                confetti.className = 'confetti-particle';
                
                // Positionne les confettis sur les côtés de l'écran
                let startX;
                const side = Math.random() < 0.5 ? 'left' : 'right';
                if (side === 'left') {
                    // Côté gauche (0% à 25% de la largeur de la fenêtre)
                    startX = Math.random() * (window.innerWidth * 0.25);
                } else {
                    // Côté droit (75% à 100% de la largeur de la fenêtre)
                    startX = (window.innerWidth * 0.75) + (Math.random() * (window.innerWidth * 0.25));
                }

                const startY = -20; // Commence juste au-dessus de l'écran

                confetti.style.left = `${startX}px`;
                confetti.style.top = `${startY}px`;
                confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                
                // Ajoute des propriétés personnalisées pour l'animation
                confetti.dataset.speed = Math.random() * 3 + 2; // Vitesse de chute
                confetti.dataset.angle = Math.random() * 360;    // Angle de rotation initial
                confetti.dataset.rotationSpeed = Math.random() * 10 - 5; // Vitesse de rotation
                
                confettiContainer.appendChild(confetti);
            }
        }
        
        function animateConfettiOnPage() {
            const particles = document.querySelectorAll('.confetti-particle');
            particles.forEach(p => {
                let currentTop = parseFloat(p.style.top);
                let speed = parseFloat(p.dataset.speed);
                let angle = parseFloat(p.dataset.angle);
                let rotationSpeed = parseFloat(p.dataset.rotationSpeed);

                p.style.top = `${currentTop + speed}px`;
                p.dataset.angle = angle + rotationSpeed;
                p.style.transform = `rotate(${angle}deg)`;

                // Supprime le confetti s'il sort de l'écran
                if (currentTop > window.innerHeight) {
                    p.remove();
                }
            });
            
            requestAnimationFrame(animateConfettiOnPage);
        }

        function drawInitialState() {
             ctx.fillStyle = "#111"; ctx.fillRect(0, 0, canvas.width, canvas.height);
             for (let i = 0; i < snake.length; i++) { ctx.fillStyle = (i === 0) ? "lime" : "green"; ctx.fillRect(snake[i].x, snake[i].y, box, box); }
             ctx.fillStyle = "white"; ctx.font = "16px 'Press Start 2P'";
             ctx.textAlign = "left"; ctx.fillText("Score: 0", 10, 25);
             ctx.textAlign = "right"; ctx.fillText("Meilleur: " + highscore, canvas.width - 10, 25);
        }

        function gameLoop() {
            let snakeX = snake[0].x;
            let snakeY = snake[0].y;
            if (d == "LEFT") snakeX -= box;
            if (d == "UP") snakeY -= box;
            if (d == "RIGHT") snakeX += box;
            if (d == "DOWN") snakeY += box;

            if (snakeX == food.x && snakeY == food.y) {
                score++;
                
                if (score > highscore) {
                    highscore = score;
                    if (!highScoreBeatenThisGame) {
                        playSound('sounds/win.mp3', 0.4); 
                        createConfettiBurst(); // Déclenche les confettis sur la page
                        highScoreBeatenThisGame = true;
                    } else {
                        playSound('sounds/eat.mp3'); 
                    }
                } else {
                    playSound('sounds/eat.mp3');
                }

                spawnFood();
                if(score % 5 === 0 && speed > 50) {
                    speed -= 10;
                    clearInterval(game);
                    game = setInterval(gameLoop, speed);
                }
            } else {
                snake.pop();
            }
            
            let newHead = { x: snakeX, y: snakeY };

            if (snakeX < 0 || snakeY < 0 || snakeX >= canvas.width || snakeY >= canvas.height || collision(newHead, snake)) {
                clearInterval(game);
                playSound('sounds/game-over.mp3', 0.5);
                localStorage.setItem('snakeHighscore', highscore); 
                finalScoreOver.innerText = score;
                highscoreOver.innerText = highscore;
                gameOverScreen.style.display = 'flex';
                return;
            }

            snake.unshift(newHead);
            
            drawGameElements();
        }
        
        function drawGameElements(){
            ctx.fillStyle = "#111"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < snake.length; i++) { ctx.fillStyle = (i === 0) ? "lime" : "green"; ctx.fillRect(snake[i].x, snake[i].y, box, box); }
            ctx.fillStyle = "red"; ctx.fillRect(food.x, food.y, box, box);
            
            // On n'appelle plus la fonction de dessin des confettis ici
            
            ctx.fillStyle = "white"; ctx.font = "16px 'Press Start 2P'";
            ctx.textAlign = "left"; ctx.fillText("Score: " + score, 10, 25);
            ctx.textAlign = "right"; ctx.fillText("Meilleur: " + highscore, canvas.width - 10, 25);
        }
        
        init();
        animateConfettiOnPage(); // Démarre la boucle d'animation des confettis en permanence
    </script>
</body>
</html>